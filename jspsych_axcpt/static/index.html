<!doctype html>
<html>
  <head>
    <title>My experiment</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugins/jspsych-text.js"></script>
    <script src="jspsych/plugins/jspsych-multi-stim-single-response.js"></script>
    <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
  </body>
  <script>

    /* define welcome message block */
    var welcome_block = {
      type: "text",
      text: "Welcome to the experiment. Press any key to begin."
    };

    /* define instructions block */
    var instructions_block = {
      type: "text",
      text: "We are instructions",
      timing_post_trial: 2000
    };

    /* define test block */

    var test_stimuli = [
      ["A"," ", "X"],
      ["A"," ", "Y"],
      ["B"," ", "X"],
      ["B"," ", "Y"]
    ];

    var responses = [
    	[70,74]
    ];

    var all_trials = jsPsych.randomization.repeat(test_stimuli, 10, true);

    var post_trial_gap = function() {
      return Math.floor( Math.random() * 1500 ) + 750;
    }

    var test_block = {
      type: "multi-stim-single-response",
      stimuli: test_stimuli,
      is_html: true,
      choices: responses,
      data: all_trials.data,
      timing_stim: [500, 2000, -1],
      timing_response: 5000,
      timing_post_trial: post_trial_gap,
      on_finish: function() {
    	console.log(jsPsych.data.getLastTrialData());
  	}
    };

    var debrief_block = {
      type: "text",
      text: function() {
        return "debriefing!"
      }
    };

    /* create experiment definition array */
    var experiment = [];
    experiment.push(welcome_block);
    experiment.push(instructions_block);
    experiment.push(test_block);
    experiment.push(debrief_block);

    function saveData(name, data){
  	  var xhr = new XMLHttpRequest();
  	  xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
  	  xhr.setRequestHeader('Content-Type', 'application/json');
  	  xhr.send(JSON.stringify({filename: name, filedata: data}));

  	  var next = moveOn();
  	  console.log("Moving to: " + next);

  	  document.open();
  	  document.write('<p style="text-align:center; font-family: Lucida, Console, monospace; font-size: large;">You can take a break now.<br /> <a href="'+next+'">Click here to continue</a>');
  	  document.close();
  	}

  function setCookie(cname, cvalue, exdays) {
  	var d = new Date();
  	d.setTime(d.getTime() + (exdays*24*60*60*1000));
  	var expires = "expires="+ d.toUTCString();
  	document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  }

  function getCookieValue(a) {
  	var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
  	return b ? b.pop() : '';
  }

  function getID() {
  	var user_id = getCookieValue("id");
  	if (user_id != "") {
  		return user_id;
  	} else {
  		window.location.href = "https://www.psycholinguistics.ml/cookie_error.html?jspsych=id";
  	}
  }

  function insertAfter(el, referenceNode) {
  	    referenceNode.parentNode.insertBefore(el, referenceNode);
  	}

  function moveOn(){
  	var sequence = getCookieValue("group");
  	var progress = getCookieValue("progress");
  	var next = "https://www.psycholinguistics.ml/cookie_error.html?jspsych=before";
  	var finalmessage = document.createElement("p");


  	if (progress != ""){
  	//update progress
  	progress = parseInt(progress)
  	progress++;
  	setCookie("progress", progress, 7);

  	//until all three elements done, continue to next test
  	if (progress<8){
  		sequence = sequence[progress];
  		switch (sequence){
  				case "A":
  				case "B":
  				case "C":
  				case "D":
  				case "E":
  				case "F":
  				case "G":
  				case "H":
  					next ="https://www.psycholinguistics.ml/ibex/experiment.html";
  					break;
  				case "J":
  					next ="https://www.psycholinguistics.ml/jspsych/experiment.html";//circles-REPLACE LATER WITH VOCAB
  					break;
  				case "K":
  					next ="https://www.psycholinguistics.ml/jspsych_1/index.html";//AXCPT
  					break;
  				case "L":
  					next ="https://www.psycholinguistics.ml/jspsych_2/reading_span_web_english.html"; //RST
  					break;
  				case "M":
  					next ="https://www.psycholinguistics.ml/jspsych_3/index.html";//Flanker
  					break;
  				case "N":
  					next ="https://www.psycholinguistics.ml/jspsych_4/index.html";//Ravens
  					break;
  				case "O":
  					next ="https://www.psycholinguistics.ml/jspsych_5/index.html";//Big5
  					break;
  				case "P":
  					next ="https://www.psycholinguistics.ml/jspsych_6/index.html";//Navon
  					break;

  				default:
  						next  = "https://www.psycholinguistics.ml/cookie_error.html?jspsych=after";
  						}
  	}	else {
  		next = "https://www.psycholinguistics.ml/finished.html";
  	}
  	}
  	return next;

  }


      var user_id = getID();

    /* start the experiment */
    jsPsych.init({
      experiment_structure: experiment,
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });
  </script>
</html>
